name: Build Plugins
on: [workflow_dispatch]

concurrency:
  group: build_plugins_${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  prepare:
    name: Prepare Repository Matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Setup jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
      - name: Read repo_urls.txt and create matrix
        id: set-matrix
        run: |
          # Read repo_urls.txt, filter out empty lines and comments, create JSON matrix
          repos=$(cat repo_urls.txt | grep -v '^$' | grep -v '^#' | jq -R -s -c 'split("\n") | map(select(length > 0)) | map({repo_url: .})')
          echo "matrix={\"include\":$repos}" >> $GITHUB_OUTPUT
          count=$(echo $repos | jq 'length')
          echo "Found $count repositories"

  build:
    name: Build ${{ matrix.repo_url }}
    needs: prepare
    permissions:
      id-token: write
      contents: write
      attestations: write
    runs-on: windows-2022
    defaults:
      run:
        shell: pwsh
    env:
      IsCI: true
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}
    steps:
      - name: Checkout build script
        uses: actions/checkout@v4
        with:
          path: build-scripts
      - name: Extract repository name
        id: repo-info
        run: |
          $repoUrl = "${{ matrix.repo_url }}"
          # Only handle GitHub URLs, skip everything else
          if ($repoUrl -match 'github\.com/([^/]+)/([^/]+)') {
              $owner = $Matches[1]
              $repo = $Matches[2]
              # Handle URLs with /tree/branch or /tree/branch/path
              if ($repo -match '^([^/]+)') {
                  $repo = $Matches[1]
              }
              echo "owner=$owner" >> $env:GITHUB_OUTPUT
              echo "repo=$repo" >> $env:GITHUB_OUTPUT
              echo "repo_name=$repo" >> $env:GITHUB_OUTPUT
              echo "skip=false" >> $env:GITHUB_OUTPUT
          } else {
              Write-Host "Skipping non-GitHub repository: $repoUrl"
              echo "skip=true" >> $env:GITHUB_OUTPUT
          }
      - name: Checkout Repository
        if: steps.repo-info.outputs.skip != 'true'
        id: checkout-repo
        continue-on-error: true
        uses: actions/checkout@v4
        with:
          repository: ${{ steps.repo-info.outputs.owner }}/${{ steps.repo-info.outputs.repo }}
          submodules: recursive
          fetch-depth: 0
          path: plugin-repo
      - name: Checkout Repository (without submodules)
        if: steps.repo-info.outputs.skip != 'true' && steps.checkout-repo.outcome == 'failure'
        uses: actions/checkout@v4
        with:
          repository: ${{ steps.repo-info.outputs.owner }}/${{ steps.repo-info.outputs.repo }}
          submodules: false
          fetch-depth: 0
          path: plugin-repo
      - name: Skip non-GitHub repositories
        if: steps.repo-info.outputs.skip == 'true'
        run: |
          echo "Skipping non-GitHub repository: ${{ matrix.repo_url }}"
      - name: Generate release tag (UTC+8)
        if: steps.repo-info.outputs.skip != 'true'
        id: generate-tag
        run: |
          # Get current time in UTC+8 (Asia/Taipei)
          $taipeiTime = [System.TimeZoneInfo]::ConvertTimeBySystemTimeZoneId([DateTime]::UtcNow, 'Taipei Standard Time')
          $datePart = $taipeiTime.ToString('yy-MM-dd')

          cd plugin-repo
          git fetch --tags
          $tags = git tag --list "$datePart-*"

          $maxNumber = 0
          foreach ($tag in $tags) {
              if ($tag -match '-(\d{2})$') {
                  $currentNumber = [int]$Matches[1]
                  if ($currentNumber -gt $maxNumber) {
                      $maxNumber = $currentNumber
                  }
              }
          }

          $nextNumber = $maxNumber + 1
          $newTag = "{0}-{1:D2}" -f $datePart, $nextNumber
          echo "new_tag=$newTag" >> $env:GITHUB_OUTPUT
          echo "TAG=$newTag" >> $env:GITHUB_ENV
          cd ..
      - name: Setup .NET
        if: steps.repo-info.outputs.skip != 'true'
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x
      - name: Download Dalamud
        if: steps.repo-info.outputs.skip != 'true'
        run: |
          Invoke-WebRequest -Uri "https://github.com/yanmucorp/Dalamud/releases/download/25-12-08-01/latest.7z" -OutFile "latest.7z"
          7z x latest.7z -o"${{ github.workspace }}/dalamud/"
      - name: Define VERSION
        if: steps.repo-info.outputs.skip != 'true'
        run: |
          cd plugin-repo
          $commit = git rev-parse --short HEAD
          $repoName = "${{ steps.repo-info.outputs.repo_name }}"
          $branch = git rev-parse --abbrev-ref HEAD

          "$repoName" | Out-File -FilePath VERSION -Encoding utf8
          "$branch" | Out-File -FilePath VERSION -Append -Encoding utf8
          "$commit" | Out-File -FilePath VERSION -Append -Encoding utf8
          cd ..
      - name: Find .csproj file
        if: steps.repo-info.outputs.skip != 'true'
        id: find-csproj
        run: |
          cd plugin-repo
          # Find .csproj file (exclude test projects and common patterns)
          $csprojFile = Get-ChildItem -Recurse -Filter "*.csproj" | Where-Object {
            $_.FullName -notmatch "\\obj\\" -and
            $_.FullName -notmatch "\\bin\\" -and
            $_.Name -notmatch "test"
          } | Select-Object -First 1
          if (-not $csprojFile) {
            Write-Error "Error: No .csproj file found"
            exit 1
          }
          $relativePath = $csprojFile.FullName.Replace((Get-Location).Path + "\", "")
          Write-Host "Found .csproj: $relativePath"
          echo "csproj_file=$relativePath" >> $env:GITHUB_OUTPUT
          cd ..
      - name: Restore Dependencies
        if: steps.repo-info.outputs.skip != 'true'
        run: |
          cd plugin-repo
          dotnet restore "${{ steps.find-csproj.outputs.csproj_file }}"
          cd ..
      - name: Build
        if: steps.repo-info.outputs.skip != 'true'
        run: |
          cd plugin-repo
          dotnet build "${{ steps.find-csproj.outputs.csproj_file }}" --configuration Release -v n /p:DALAMUD_HOME="${{ github.workspace }}/dalamud" /p:SolutionDir="$(Get-Location)" -o ./bin/Release
          cd ..
        env:
          DOTNET_CLI_TELEMETRY_OPTOUT: true
      - name: Upload artifact
        if: steps.repo-info.outputs.skip != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: plugins-artifact-${{ steps.repo-info.outputs.repo_name }}
          path: plugin-repo/bin/Release
          if-no-files-found: error
